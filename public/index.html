<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Report Template Studio</title>
    <style>
      :root {
        font-family: "Inter", system-ui, -apple-system, sans-serif;
        color: #0f172a;
        background-color: #f8fafc;
      }
      body {
        margin: 0;
        padding: 0;
      }
      header {
        background: #0f172a;
        color: white;
        padding: 16px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      main {
        padding: 24px;
        display: grid;
        gap: 24px;
        grid-template-columns: 320px 1fr;
      }
      h1,
      h2,
      h3 {
        margin: 0 0 12px 0;
      }
      .card {
        background: white;
        padding: 16px;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }
      label {
        display: block;
        font-size: 13px;
        color: #475569;
        margin-bottom: 4px;
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        margin-bottom: 10px;
        font-size: 14px;
      }
      textarea {
        min-height: 80px;
      }
      button {
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 8px 12px;
        cursor: pointer;
        font-weight: 600;
      }
      button.secondary {
        background: #e2e8f0;
        color: #0f172a;
      }
      .template-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .template-item {
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 10px 12px;
        background: white;
        cursor: pointer;
      }
      .template-item.active {
        border-color: #2563eb;
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
      }
      .section-row {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 12px;
        background: #f8fafc;
      }
      .inline {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
      }
      .flex {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 9999px;
        background: #e0f2fe;
        color: #075985;
        font-size: 12px;
        font-weight: 600;
      }
      .issues {
        margin-top: 12px;
        padding: 12px;
        background: #fef2f2;
        border: 1px solid #fecdd3;
        border-radius: 8px;
        color: #991b1b;
      }
      .success {
        margin-top: 12px;
        padding: 12px;
        background: #ecfdf3;
        border: 1px solid #bbf7d0;
        border-radius: 8px;
        color: #14532d;
      }
      @media (max-width: 960px) {
        main {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div>
        <h1>Template Studio</h1>
        <small>Evidence-aware report templates with validation</small>
      </div>
    </header>
    <main>
      <section class="card">
        <h2>Create Template</h2>
        <form id="template-form">
          <label for="template-name">Name</label>
          <input id="template-name" name="name" required />
          <label for="template-description">Description</label>
          <textarea id="template-description" name="description"></textarea>
          <label for="template-formats">Formats (comma separated)</label>
          <input
            id="template-formats"
            name="formats"
            placeholder="markdown, docx"
          />
          <button type="submit">Create template</button>
        </form>
        <h2 style="margin-top: 16px">Templates</h2>
        <div id="template-list" class="template-list"></div>
      </section>
      <section class="card">
        <div id="editor-panel">
          <h2>Template Editor</h2>
          <p>Select a template to edit sections, validate, and publish.</p>
        </div>
      </section>
    </main>

    <script>
      const state = {
        templates: [],
        selectedTemplateId: null,
        validation: null,
        publishMessage: "",
      };

      async function fetchTemplates() {
        const res = await fetch("/api/templates");
        const data = await res.json();
        state.templates = data;
        renderTemplates();
        renderEditor();
      }

      async function createTemplate(event) {
        event.preventDefault();
        const form = event.target;
        const payload = {
          name: form.name.value.trim(),
          description: form.description.value.trim(),
          formats: form.formats.value
            .split(",")
            .map((f) => f.trim())
            .filter(Boolean),
        };
        const res = await fetch("/api/templates", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          alert("Failed to create template");
          return;
        }
        const template = await res.json();
        state.selectedTemplateId = template.id;
        form.reset();
        await fetchTemplates();
      }

      function renderTemplates() {
        const container = document.getElementById("template-list");
        container.innerHTML = "";
        state.templates.forEach((template) => {
          const item = document.createElement("div");
          item.className =
            "template-item" +
            (template.id === state.selectedTemplateId ? " active" : "");
          item.innerHTML = `
            <div class="flex" style="justify-content: space-between;">
              <div>
                <strong>${template.name}</strong>
                <div style="font-size: 12px; color: #475569;">
                  ${template.description || "No description"}
                </div>
              </div>
              <span class="badge">${template.status}</span>
            </div>
          `;
          item.onclick = () => {
            state.selectedTemplateId = template.id;
            state.validation = null;
            state.publishMessage = "";
            renderTemplates();
            renderEditor();
          };
          container.appendChild(item);
        });
      }

      function renderEditor() {
        const panel = document.getElementById("editor-panel");
        const template = state.templates.find(
          (t) => t.id === state.selectedTemplateId
        );
        if (!template) {
          panel.innerHTML =
            "<h2>Template Editor</h2><p>Select a template to get started.</p>";
          return;
        }

        const sections = (template.sections || []).slice().sort((a, b) => {
          return (a.order || 0) - (b.order || 0);
        });

        panel.innerHTML = `
          <div class="flex" style="justify-content: space-between;">
            <div>
              <h2>${template.name}</h2>
              <p style="margin: 4px 0;">${template.description || ""}</p>
              <div style="font-size: 12px; color: #475569;">
                Formats: ${(template.formats || []).join(", ") || "n/a"}
              </div>
            </div>
            <div class="flex">
              <button class="secondary" id="validate-btn">Validate</button>
              <button id="publish-btn">Publish</button>
            </div>
          </div>
          <div id="validation-output"></div>
          <h3 style="margin-top: 16px;">Sections</h3>
          <div id="sections-container"></div>
          <h3 style="margin-top: 12px;">Add Section</h3>
          <form id="section-form">
            <div class="inline">
              <div>
                <label for="section-title">Title</label>
                <input id="section-title" name="title" required />
              </div>
              <div>
                <label for="section-order">Order</label>
                <input id="section-order" name="order" type="number" min="1" value="${sections.length +
          1}" />
              </div>
            </div>
            <label for="section-purpose">Purpose</label>
            <textarea id="section-purpose" name="purpose"></textarea>
            <div class="inline">
              <div>
                <label for="section-evidence">Evidence Policy</label>
                <select id="section-evidence" name="evidencePolicy">
                  <option value="EVIDENCE_REQUIRED">EVIDENCE_REQUIRED</option>
                  <option value="EVIDENCE_OPTIONAL">EVIDENCE_OPTIONAL</option>
                  <option value="SYNTHESIS_ONLY">SYNTHESIS_ONLY</option>
                </select>
              </div>
              <div>
                <label for="section-retrieval">Retrieval Method</label>
                <select id="section-retrieval" name="retrievalMethod">
                  <option value="SYNTHESIS_ONLY">SYNTHESIS_ONLY</option>
                  <option value="VECTOR_ONLY">VECTOR_ONLY</option>
                  <option value="WEB_ONLY">WEB_ONLY</option>
                  <option value="VECTOR_AND_WEB">VECTOR_AND_WEB</option>
                </select>
              </div>
            </div>
            <label for="section-formats">Formats (comma separated)</label>
            <input id="section-formats" name="formats" />
            <label for="section-prompt">Prompt</label>
            <textarea id="section-prompt" name="prompt"></textarea>
            <button type="submit">Add section</button>
          </form>
        `;

        document
          .getElementById("section-form")
          .addEventListener("submit", addSection);
        document
          .getElementById("validate-btn")
          .addEventListener("click", runValidation);
        document
          .getElementById("publish-btn")
          .addEventListener("click", publishTemplate);

        const sectionsContainer = document.getElementById("sections-container");
        sections.forEach((section) => {
          const wrapper = document.createElement("div");
          wrapper.className = "section-row";
          wrapper.innerHTML = `
            <div class="inline">
              <div>
                <label>Title</label>
                <input data-field="title" data-id="${section.id}" value="${section.title || ""}" />
              </div>
              <div>
                <label>Order</label>
                <input type="number" min="1" data-field="order" data-id="${section.id}" value="${section.order || 1}" />
              </div>
            </div>
            <label>Purpose</label>
            <textarea data-field="purpose" data-id="${section.id}">${section.purpose || ""}</textarea>
            <div class="inline">
              <div>
                <label>Evidence Policy</label>
                <select data-field="evidencePolicy" data-id="${section.id}">
                  ${["EVIDENCE_REQUIRED","EVIDENCE_OPTIONAL","SYNTHESIS_ONLY"]
                    .map(
                      (value) =>
                        `<option value="${value}" ${
                          section.evidencePolicy === value ? "selected" : ""
                        }>${value}</option>`
                    )
                    .join("")}
                </select>
              </div>
              <div>
                <label>Retrieval Method</label>
                <select data-field="retrievalMethod" data-id="${section.id}">
                  ${["SYNTHESIS_ONLY","VECTOR_ONLY","WEB_ONLY","VECTOR_AND_WEB"]
                    .map(
                      (value) =>
                        `<option value="${value}" ${
                          section.retrievalMethod === value ? "selected" : ""
                        }>${value}</option>`
                    )
                    .join("")}
                </select>
              </div>
            </div>
            <label>Formats</label>
            <input data-field="formats" data-id="${section.id}" value="${(section.formats || []).join(
              ", "
            )}" />
            <label>Prompt</label>
            <textarea data-field="prompt" data-id="${section.id}">${section.prompt || ""}</textarea>
            <div class="flex" style="justify-content: flex-end;">
              <button data-action="update" data-id="${section.id}">Save</button>
            </div>
          `;
          wrapper
            .querySelector('[data-action="update"]')
            .addEventListener("click", () => updateSection(section.id));
          sectionsContainer.appendChild(wrapper);
        });

        renderValidation();
      }

      async function addSection(event) {
        event.preventDefault();
        const templateId = state.selectedTemplateId;
        const form = event.target;
        const payload = {
          title: form.title.value.trim(),
          order: Number(form.order.value) || 1,
          purpose: form.purpose.value.trim(),
          evidencePolicy: form.evidencePolicy.value,
          retrievalMethod: form.retrievalMethod.value,
          formats: form.formats.value
            .split(",")
            .map((f) => f.trim())
            .filter(Boolean),
          prompt: form.prompt.value.trim(),
        };
        const res = await fetch(`/api/templates/${templateId}/sections`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          alert("Unable to add section");
          return;
        }
        form.reset();
        await fetchTemplates();
      }

      async function updateSection(sectionId) {
        const templateId = state.selectedTemplateId;
        const inputs = document.querySelectorAll(`[data-id="${sectionId}"]`);
        const payload = {};
        inputs.forEach((el) => {
          const key = el.getAttribute("data-field");
          if (key === "order") {
            payload[key] = Number(el.value);
          } else if (key === "formats") {
            payload[key] = el.value
              .split(",")
              .map((f) => f.trim())
              .filter(Boolean);
          } else {
            payload[key] = el.value;
          }
        });
        const res = await fetch(
          `/api/templates/${templateId}/sections/${sectionId}`,
          {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          }
        );
        if (!res.ok) {
          alert("Unable to update section");
          return;
        }
        await fetchTemplates();
      }

      async function runValidation() {
        const templateId = state.selectedTemplateId;
        const res = await fetch(`/api/templates/${templateId}/validate`, {
          method: "POST",
        });
        const data = await res.json();
        state.validation = data;
        renderValidation();
      }

      async function publishTemplate() {
        const templateId = state.selectedTemplateId;
        const res = await fetch(`/api/templates/${templateId}/publish`, {
          method: "POST",
        });
        if (!res.ok) {
          const payload = await res.json();
          state.validation = payload;
          state.publishMessage = "";
          renderValidation();
          return;
        }
        const payload = await res.json();
        state.publishMessage = payload.message;
        await fetchTemplates();
        renderValidation();
      }

      function renderValidation() {
        const container = document.getElementById("validation-output");
        if (!container) return;
        const result = state.validation;
        container.innerHTML = "";
        if (state.publishMessage) {
          const div = document.createElement("div");
          div.className = "success";
          div.textContent = state.publishMessage;
          container.appendChild(div);
        }
        if (!result) return;
        if (result.valid) {
          const div = document.createElement("div");
          div.className = "success";
          div.textContent = "Validation passed (no P0 issues).";
          container.appendChild(div);
          return;
        }
        const issues = document.createElement("div");
        issues.className = "issues";
        issues.innerHTML = `<strong>Validation failed:</strong><ul>${(result.issues || [])
          .map((issue) => `<li>${issue.message}</li>`)
          .join("")}</ul>`;
        container.appendChild(issues);
      }

      document
        .getElementById("template-form")
        .addEventListener("submit", createTemplate);

      fetchTemplates();
    </script>
  </body>
</html>
